<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shiro.steel.mapper.SaleContractAnalyseMapper">
 <select id="selectList" resultType="com.shiro.steel.pojo.dto.SaleReportDto">
select ssc.contractNo as contractno,ssc.contractWeight as contractweight,
	    ssc.contractAmount as contractamount,
	    ssc.customerName as customername,
	    ssc.actualWeight as actualweight,
	    ssc.actualAmount as actualamount,
		ssc.stockOutTotalFee as stockouttotalfee,
		ssc.shortTransportTotalFee as shorttransporttotalfee,
		stocksum.stockamount as purchaseamount,stocksum.stocksum as purchaseweight,sum(deo.overtimeFee)as overtimefee,sum(pro.processFee)as processfee,sum(tro.transportFee) as transportfee,
		(ssc.actualAmount-ssc.stockOutTotalFee-ssc.shortTransportTotalFee-stocksum.stockamount-IFNULL(overtimefee,0)-IFNULL(processfee,0) - IFNULL(transportfee,0)) as grossprofit
		from sale_contract ssc left JOIN
		(SELECT
			sc.contractNo,
			sum(scd.num*stock.weight) as stocksum,
			sum(stock.price * scd.num*stock.weight) as stockamount,
			stockid
		FROM
			sale_contract sc
		LEFT JOIN sale_contract_detail scd ON sc.contractNo = scd.contractNo
		LEFT JOIN stock ON scd.stockid = stock.id
		GROUP BY
			scd.contractNo) as stocksum on stocksum.contractNo = ssc.contractNo
		left JOIN delivery_order deo on deo.contractNo = ssc.contractNo
		left join process_order pro on pro.contractNo = ssc.contractNo
		left join transport_order tro on tro.contractNo = ssc.contractNo

		WHERE 1=1
		<if test="''!= dto.keyword and dto.keyword!=null">
        AND ssc.customerName LIKE CONCAT('%',#{dto.keyword},'%')
		</if>
		<if test="''!=createby and createby!=null">
       	AND ssc.createBy =#{createby}
		</if>

	 	<if test="startTime != null and startTime != ''">
		 AND  DATE_FORMAT(ssc.contractDate,'%Y-%m-%d') <![CDATA[>=]]> DATE_FORMAT(#{startTime},'%Y-%m-%d')
 		</if>
	 	<if test="endTime != null and endTime != ''">
		 AND  DATE_FORMAT(ssc.contractDate,'%Y-%m-%d')  <![CDATA[<=]]> DATE_FORMAT(#{endTime},'%Y-%m-%d ')
	 	</if>
       GROUP BY ssc.contractNo order by ssc.crt desc
	</select>
	
</mapper>